<%
function isNonBlankString(s) {
  return s && (s.trim().length > 0);
}

var address = null;
var latitude = null;
var longitude = null;
var label = null;

try {
  var usAddressResults = recognitionResults['com.solveforall.recognition.location.UsAddress'];
  
  if (usAddressResults && (usAddressResults.length > 0)) {
    var recognitionResult = usAddressResults[0];

    var address = recognitionResult.streetAddress || '';

    var city = recognitionResult.city;
    if (isNonBlankString(city)) {
      if (address.length > 0) {
        address += ', ';
      }

      address += city;
    }

    var state = recognitionResult.stateAbbreviation;
    if (isNonBlankString(state)) {
      if (address.length > 0) {
        address += ', ';
      }

      address += state;
    }

    var zipCode = recognitionResult.zipCode;
    if (isNonBlankString(zipCode)) {
      if (address.length > 0) {
        address += ' ';
      }
      address += zipCode;
    }
  } else {
    var geoResults = recognitionResults['com.solveforall.recognition.location.GeoCoordinates'];
    var geoResult = null;
    
    if (geoResults && (geoResult.length > 0)) {
      geoResult = geoResults[0];      
    } else {
      var wikipediaResults = recognitionResults['com.solveforall.recognition.WikipediaArticle'];      

      geoResult = _(wikipediaResults).find(function (wr) {
        return wr.longitude && wr.latitude;
      });
    }
    
    if (geoResult) {
      label = geoResult.matchedText;
      latitude = geoResult.latitude;
      longitude = geoResult.longitude;            
    }      
  }
} catch (e) {
  console.log('Recognition result not found, falling back to query, error message = "' + 
              e.message + "'");  
}

if (!address && !latitude) {
  address = q;   
}

var settings = context.settings;
%>
<!DOCTYPE html>
<html>
<head>
  <% if (address) { %>
    <meta name="com.solveforall.meta.answer.uri" content="https://maps.google.com/maps?q=<%= encodeURIComponent(address) %>">
  <% } %>
  <title>Google Maps</title>
  <style>
       html { height: 100% }
       body { height: 100%; margin: 0px; padding: 0px }
       #map_canvas { height: 20% }
  </style>
</head>
<body>
  <section style="width:100%; height:100%" >
    <div id="map_canvas" style="width:100%; height:100%"></div>
  </section>

  <div id="data" 
  <% if (address) { %>
    data-label="<%= address %>"
    data-address="<%= address %>"
  <% } else if (latitude) { %>
    data-label="<%= label %>"
    data-latitude="<%= latitude %>" data-longitude="<%= longitude %>"    
  <% } %>  
    data-zoom="<%= (settings.zoomLevel || 15) %>"
    data-map-type="<%= (settings.mapType || 'roadmap') %>"
    data-tilt="<%= (settings.tilt || 'true') %>"
  ></div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js">
  </script>
  <script src="https://maps.google.com/maps/api/js?sensor=false"></script>
  <script src="https://googledrive.com/host/0B9oRjsJCVus3SGczand1LThickk/map.js">
  </script>
</body>
</html>
